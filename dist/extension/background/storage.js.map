{
  "version": 3,
  "sources": ["../../../extension/background/storage.ts"],
  "sourcesContent": ["// extension/background/storage.ts\r\n// WARNING-ONLY version: no redaction, no text insertion\r\n\r\ntype RiskLevel = \"ALLOW\" | \"WARN\" | \"BLOCK\";\r\ntype ModalChoice = \"continue\";\r\ntype PromptEventSource = \"paste\" | \"send\";\r\n\r\ntype AnalyticsEvent = {\r\n  type: \"APG_ANALYTICS_EVENT\";\r\n  payload: {\r\n    ts: number; // unix ms\r\n    host: string; // e.g. chat.openai.com\r\n    source: PromptEventSource; // paste or send\r\n    riskLevel: Exclude<RiskLevel, \"ALLOW\">; // only WARN/BLOCK are logged\r\n    riskScore: number; // 0..1\r\n    categories: string[]; // e.g. [\"API_KEY\",\"EMAIL\"] (no content)\r\n    action: ModalChoice; // continue\r\n  };\r\n};\r\n\r\ntype AnalyticsStoreV1 = {\r\n  version: 1;\r\n\r\n  // totals\r\n  warningsTotal: number; // WARN + BLOCK events\r\n\r\n  // breakdowns\r\n  byHost: Record<string, number>;\r\n  byCategory: Record<string, number>;\r\n  byAction: Record<ModalChoice, number>;\r\n  bySource: Record<PromptEventSource, number>;\r\n  byRiskLevel: Record<Exclude<RiskLevel, \"ALLOW\">, number>;\r\n\r\n  // time series (simple daily buckets)\r\n  daily: Record<string, number>; // YYYY-MM-DD -> count\r\n};\r\n\r\nconst STORAGE_KEY = \"apg_analytics\";\r\n\r\nfunction todayKey(ts: number): string {\r\n  const d = new Date(ts);\r\n  // YYYY-MM-DD in local time\r\n  const yyyy = d.getFullYear();\r\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\r\n  const dd = String(d.getDate()).padStart(2, \"0\");\r\n  return `${yyyy}-${mm}-${dd}`;\r\n}\r\n\r\nfunction defaultStore(): AnalyticsStoreV1 {\r\n  return {\r\n    version: 1,\r\n    warningsTotal: 0,\r\n    byHost: {},\r\n    byCategory: {},\r\n    byAction: { continue: 0 },\r\n    bySource: { paste: 0, send: 0 },\r\n    byRiskLevel: { WARN: 0, BLOCK: 0 },\r\n    daily: {},\r\n  };\r\n}\r\n\r\nasync function getStore(): Promise<AnalyticsStoreV1> {\r\n  const res = await chrome.storage.local.get(STORAGE_KEY);\r\n  const existing = res[STORAGE_KEY] as AnalyticsStoreV1 | undefined;\r\n\r\n  if (!existing) return defaultStore();\r\n\r\n  // Simple versioning hook for future migrations\r\n  if (existing.version !== 1) {\r\n    // If somehow future/unknown, reset safely\r\n    return defaultStore();\r\n  }\r\n\r\n  return existing;\r\n}\r\n\r\nasync function setStore(store: AnalyticsStoreV1): Promise<void> {\r\n  await chrome.storage.local.set({ [STORAGE_KEY]: store });\r\n}\r\n\r\nfunction inc(obj: Record<string, number>, key: string, amt = 1) {\r\n  obj[key] = (obj[key] ?? 0) + amt;\r\n}\r\n\r\nasync function applyEvent(ev: AnalyticsEvent[\"payload\"]) {\r\n  const store = await getStore();\r\n\r\n  store.warningsTotal += 1;\r\n\r\n  inc(store.byHost, ev.host);\r\n  for (const cat of ev.categories) inc(store.byCategory, cat);\r\n\r\n  store.byAction[ev.action] = (store.byAction[ev.action] ?? 0) + 1;\r\n  store.bySource[ev.source] = (store.bySource[ev.source] ?? 0) + 1;\r\n  store.byRiskLevel[ev.riskLevel] = (store.byRiskLevel[ev.riskLevel] ?? 0) + 1;\r\n\r\n  const day = todayKey(ev.ts);\r\n  inc(store.daily, day);\r\n\r\n  await setStore(store);\r\n}\r\n\r\nchrome.runtime.onMessage.addListener((message: unknown, _sender, sendResponse) => {\r\n  const msg = message as Partial<AnalyticsEvent>;\r\n\r\n  if (msg?.type !== \"APG_ANALYTICS_EVENT\" || !msg.payload) {\r\n    // Not ours\r\n    return false;\r\n  }\r\n\r\n  // Fire-and-forget async work; respond immediately\r\n  applyEvent(msg.payload).then(\r\n    () => sendResponse({ ok: true }),\r\n    (err) => sendResponse({ ok: false, error: String(err) })\r\n  );\r\n\r\n  return true; // indicates async response\r\n});\r\n"],
  "mappings": ";;;AAqCA,MAAM,cAAc;AAEpB,WAAS,SAAS,IAAoB;AACpC,UAAM,IAAI,IAAI,KAAK,EAAE;AAErB,UAAM,OAAO,EAAE,YAAY;AAC3B,UAAM,KAAK,OAAO,EAAE,SAAS,IAAI,CAAC,EAAE,SAAS,GAAG,GAAG;AACnD,UAAM,KAAK,OAAO,EAAE,QAAQ,CAAC,EAAE,SAAS,GAAG,GAAG;AAC9C,WAAO,GAAG,IAAI,IAAI,EAAE,IAAI,EAAE;AAAA,EAC5B;AAEA,WAAS,eAAiC;AACxC,WAAO;AAAA,MACL,SAAS;AAAA,MACT,eAAe;AAAA,MACf,QAAQ,CAAC;AAAA,MACT,YAAY,CAAC;AAAA,MACb,UAAU,EAAE,UAAU,EAAE;AAAA,MACxB,UAAU,EAAE,OAAO,GAAG,MAAM,EAAE;AAAA,MAC9B,aAAa,EAAE,MAAM,GAAG,OAAO,EAAE;AAAA,MACjC,OAAO,CAAC;AAAA,IACV;AAAA,EACF;AAEA,iBAAe,WAAsC;AACnD,UAAM,MAAM,MAAM,OAAO,QAAQ,MAAM,IAAI,WAAW;AACtD,UAAM,WAAW,IAAI,WAAW;AAEhC,QAAI,CAAC,SAAU,QAAO,aAAa;AAGnC,QAAI,SAAS,YAAY,GAAG;AAE1B,aAAO,aAAa;AAAA,IACtB;AAEA,WAAO;AAAA,EACT;AAEA,iBAAe,SAAS,OAAwC;AAC9D,UAAM,OAAO,QAAQ,MAAM,IAAI,EAAE,CAAC,WAAW,GAAG,MAAM,CAAC;AAAA,EACzD;AAEA,WAAS,IAAI,KAA6B,KAAa,MAAM,GAAG;AAhFhE;AAiFE,QAAI,GAAG,MAAK,SAAI,GAAG,MAAP,YAAY,KAAK;AAAA,EAC/B;AAEA,iBAAe,WAAW,IAA+B;AApFzD;AAqFE,UAAM,QAAQ,MAAM,SAAS;AAE7B,UAAM,iBAAiB;AAEvB,QAAI,MAAM,QAAQ,GAAG,IAAI;AACzB,eAAW,OAAO,GAAG,WAAY,KAAI,MAAM,YAAY,GAAG;AAE1D,UAAM,SAAS,GAAG,MAAM,MAAK,WAAM,SAAS,GAAG,MAAM,MAAxB,YAA6B,KAAK;AAC/D,UAAM,SAAS,GAAG,MAAM,MAAK,WAAM,SAAS,GAAG,MAAM,MAAxB,YAA6B,KAAK;AAC/D,UAAM,YAAY,GAAG,SAAS,MAAK,WAAM,YAAY,GAAG,SAAS,MAA9B,YAAmC,KAAK;AAE3E,UAAM,MAAM,SAAS,GAAG,EAAE;AAC1B,QAAI,MAAM,OAAO,GAAG;AAEpB,UAAM,SAAS,KAAK;AAAA,EACtB;AAEA,SAAO,QAAQ,UAAU,YAAY,CAAC,SAAkB,SAAS,iBAAiB;AAChF,UAAM,MAAM;AAEZ,SAAI,2BAAK,UAAS,yBAAyB,CAAC,IAAI,SAAS;AAEvD,aAAO;AAAA,IACT;AAGA,eAAW,IAAI,OAAO,EAAE;AAAA,MACtB,MAAM,aAAa,EAAE,IAAI,KAAK,CAAC;AAAA,MAC/B,CAAC,QAAQ,aAAa,EAAE,IAAI,OAAO,OAAO,OAAO,GAAG,EAAE,CAAC;AAAA,IACzD;AAEA,WAAO;AAAA,EACT,CAAC;",
  "names": []
}
